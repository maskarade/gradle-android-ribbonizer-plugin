/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package com.shogo82148.ribbonizer.plugin

import com.android.build.gradle.AppExtension
import org.gradle.api.Project
import org.gradle.api.Plugin
import org.gradle.api.Task
import java.util.*

class RibbonizerPlugin: Plugin<Project> {
    override fun apply(project: Project) {
        project.extensions.add(RibbonizerExtension.NAME, RibbonizerExtension::class.java)

        project.afterEvaluate {
            val android = project.extensions.findByType(AppExtension::class.java)
                ?: throw Exception("Not an Android application; you forget `apply plugin: 'com.android.application`?")
            val extension = project.extensions.findByType(RibbonizerExtension::class.java)!!

            val tasks = mutableListOf<Task>()

            android.applicationVariants.all { variant ->
                if ((!variant.buildType.isDebuggable) &&
                    (!extension.forcedVariantsNames.contains(variant.name))
                ) {
                    project.logger.info("[ribbonizer] skip ${variant.name} because it is not debuggable and not forced.")
                    return@all
                }

                var filterBuilders = extension.filterBuilders

                val name = "${RibbonizerTask.NAME}${capitalize(variant.name)}"
                val task = project.task(
                    mapOf("type" to RibbonizerTask::class.java),
                    name
                ) as RibbonizerTask
                task.variant = variant
                task.filterBuilders = filterBuilders
                tasks.add(task)
            }

            project.task(mapOf("dependsOn" to tasks), RibbonizerTask.NAME)
        }
    }
}

fun capitalize(string: String): String {
    return string.substring(0, 1).toUpperCase(Locale.ROOT) + string.substring(1)
}